<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Market Sync</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script type="module" src="https://cdn.jsdelivr.net/npm/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <style>
        body { background: #f8fbf9; padding-bottom: 120px; font-family: 'Segoe UI', sans-serif; }
        /* Sticky Logic: Prevents flicker on reload */
        .market-mode-active #addSection { display: none !important; }
        
        .card-custom { border: none; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.04); }
        .meter-sticky { position: sticky; top: 10px; z-index: 900; background: white; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 75px; background: white; display: flex; align-items: center; border-top: 1px solid #eee; z-index: 1050; }
        .nav-link { text-align: center; flex: 1; color: #8e8e93; text-decoration: none; font-size: 11px; font-weight: bold; }
        .nav-link.active { color: #28a745; }
        
        /* Floating Catalog Button */
        .catalog-fab { position: fixed; bottom: 90px; right: 20px; width: 60px; height: 60px; border-radius: 30px; background: #28a745; color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(40,167,69,0.4); z-index: 1000; border: none; }
    </style>
    <script>
        // IMMEDIATE CHECK: Run this before the body even renders to stop flickering
        if (localStorage.getItem('marketMode') === 'enabled') {
            document.documentElement.classList.add('market-mode-active');
        }
    </script>
</head>
<body>

<div class="container py-4" style="max-width: 500px;">
    
    <div class="card card-custom p-3 mb-4 meter-sticky shadow-sm">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="fw-bold m-0 text-primary small">TRIP METER</h6>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="marketModeToggle">
                <label class="form-check-label small fw-bold" for="marketModeToggle">MARKET MODE</label>
            </div>
        </div>
        <div class="progress mb-2" style="height: 10px; border-radius: 10px;">
            <div class="progress-bar {% if trip_percent > 90 %}bg-danger{% else %}bg-primary{% endif %}" style="width: {{ trip_percent }}%"></div>
        </div>
        <div class="d-flex justify-content-between small fw-bold text-muted">
            <span>₦{{ "{:,.0f}".format(trip_spent) }}</span>
            <span>₦{{ "{:,.0f}".format(trip_remaining) }} LEFT</span>
        </div>
    </div>

    <div id="addSection">
        <div class="card card-custom p-4 bg-white mb-4 shadow-sm">
            <form action="/add" method="POST">
                <input list="grocery-suggestions" name="item_name" id="item_name" class="form-control mb-3 py-3 border-light bg-light rounded-4" placeholder="Add item..." required autocomplete="off">
                <datalist id="grocery-suggestions">
                    {% for item in suggestions %}<option value="{{ item }}">{% endfor %}
                </datalist>
                <div class="row g-2 mb-3">
                    <div class="col-6"><input type="text" name="quantity" class="form-control py-2 bg-light border-0" placeholder="Qty"></div>
                    <div class="col-6"><input type="number" name="cost" id="cost" class="form-control py-2 bg-light border-0" placeholder="Price ₦"></div>
                </div>
                <button class="btn btn-success w-100 fw-bold py-3 rounded-pill">Add to Plan</button>
            </form>
        </div>

        {% if drafts %}
        <div class="d-flex justify-content-between align-items-center mb-3 px-2">
            <h6 class="fw-bold text-muted m-0 small">PLANNING (₦{{ "{:,.0f}".format(draft_total) }})</h6>
            <a href="/ready_to_shop" class="btn btn-sm btn-dark rounded-pill px-3">Lock List</a>
        </div>
        {% for item in drafts %}
        <div class="card card-custom p-3 bg-white mb-2 d-flex flex-row justify-content-between align-items-center border-start border-4 border-secondary">
            <div><div class="fw-bold">{{ item.item_name }}</div><small class="text-muted">{{ item.quantity }}</small></div>
            <div class="text-end">
                <div class="fw-bold text-success">₦{{ "{:,.0f}".format(item.total_price) }}</div>
                <a href="/delete/{{ item.id }}" class="text-danger small text-decoration-none">Remove</a>
            </div>
        </div>
        {% endfor %}
        {% endif %}
    </div>

    <div id="checklistSection">
        <h6 class="fw-bold text-primary small px-2 mb-3 mt-4 text-uppercase">Checklist</h6>
        {% for item in checklist %}
        <div class="card card-custom p-3 bg-white d-flex flex-row align-items-center mb-2 shadow-sm border-start border-4 border-warning">
            <a href="/toggle/{{ item.id }}" class="me-3 text-muted" style="font-size: 32px;"><ion-icon name="ellipse-outline"></ion-icon></a>
            <div class="flex-grow-1"><div class="fw-bold">{{ item.item_name }}</div><small class="text-muted">{{ item.quantity }}</small></div>
            <div class="fw-bold">₦{{ "{:,.0f}".format(item.total_price) }}</div>
        </div>
        {% endfor %}

        {% if bought_items %}
        <h6 class="fw-bold text-success small px-2 mb-3 mt-4 text-uppercase">In the Bag</h6>
        {% for item in bought_items %}
        <div class="card card-custom p-2 bg-light d-flex flex-row align-items-center mb-2 border-0" style="opacity: 0.6;">
            <a href="/toggle/{{ item.id }}" class="me-3 text-success" style="font-size: 24px;"><ion-icon name="checkmark-circle"></ion-icon></a>
            <div class="flex-grow-1 text-decoration-line-through">{{ item.item_name }}</div>
            <div class="fw-bold small">₦{{ "{:,.0f}".format(item.total_price) }}</div>
        </div>
        {% endfor %}
        <div class="text-center mt-4"><a href="/end_trip" class="btn btn-outline-danger rounded-pill px-4 fw-bold">End Trip</a></div>
        {% endif %}
    </div>
</div>

<button class="catalog-fab" type="button" data-bs-toggle="offcanvas" data-bs-target="#catalogDrawer">
    <ion-icon name="grid-outline" size="large"></ion-icon>
</button>

<div class="offcanvas offcanvas-bottom" tabindex="-1" id="catalogDrawer" style="height: 60vh; border-radius: 25px 25px 0 0;">
    <div class="offcanvas-header border-bottom">
        <h5 class="offcanvas-title fw-bold">Master Catalog</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
        {% for category, items in master_catalog.items() %}
        <h6 class="fw-bold text-muted small mt-3">{{ category }}</h6>
        <div class="d-flex flex-wrap gap-2 mb-3">
            {% for item in items %}
            <span class="badge bg-light text-dark border p-2" style="cursor:pointer" onclick="fillForm('{{item}}')" data-bs-dismiss="offcanvas">+ {{ item }}</span>
            {% endfor %}
        </div>
        {% endfor %}
    </div>
</div>

<nav class="bottom-nav">
    <a href="/" class="nav-link active"><ion-icon name="list-outline" size="large"></ion-icon><br>LIST</a>
    <a href="/dashboard" class="nav-link"><ion-icon name="bar-chart-outline" size="large"></ion-icon><br>STATS</a>
    <a href="/history" class="nav-link"><ion-icon name="time-outline" size="large"></ion-icon><br>HISTORY</a>
    <a href="/settings" class="nav-link"><ion-icon name="settings-outline" size="large"></ion-icon><br>SETUP</a>
</nav>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function fillForm(name) {
        document.getElementById('item_name').value = name;
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    const toggle = document.getElementById('marketModeToggle');
    
    // Check initial state from localStorage
    if (localStorage.getItem('marketMode') === 'enabled') {
        toggle.checked = true;
    }

    toggle.addEventListener('change', function() {
        if (this.checked) {
            localStorage.setItem('marketMode', 'enabled');
            document.documentElement.classList.add('market-mode-active');
        } else {
            localStorage.setItem('marketMode', 'disabled');
            document.documentElement.classList.add('market-mode-active'); // temporarily keep class
            setTimeout(() => {
                document.documentElement.classList.remove('market-mode-active');
            }, 10);
            location.reload(); // Refresh to show the add section properly
        }
    });

    // Auto-reset Market Mode on End Trip
    document.querySelector('a[href="/end_trip"]')?.addEventListener('click', () => {
        localStorage.setItem('marketMode', 'disabled');
    });
</script>
</body>
</html>